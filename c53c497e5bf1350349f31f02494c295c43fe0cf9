{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "05dff8b4_b86dc006",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-16T14:03:27Z",
      "side": 1,
      "message": "@luca I have created a monorail issue to track this[1]\n\nI hope is detailed enough\n\nfeel free to add it to the commit message footer.\n\n[]https://bugs.chromium.org/p/gerrit/issues/detail?id\u003d14796",
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a2277520_ae1332ad",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-16T14:04:34Z",
      "side": 1,
      "message": "@luca, I have tested both sync and async path.\nWith the exception of the logging issue, I am happy with the results.",
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "90fa8b90_2d3a7d26",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-07-16T08:27:51Z",
      "side": 1,
      "message": "nit: this and the following files are in the same \u0027common\u0027 package hence all of them (including the interface) can be package protected (including constructors ;))",
      "range": {
        "startLine": 36,
        "startChar": 0,
        "endLine": 36,
        "endChar": 7
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "65899af5_f50437b5",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "Done, good catch.",
      "parentUuid": "90fa8b90_2d3a7d26",
      "range": {
        "startLine": 36,
        "startChar": 0,
        "endLine": 36,
        "endChar": 7
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2fd7366b_c07bff4e",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 62,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-16T14:03:27Z",
      "side": 1,
      "message": "I tested the failure path and this causes the toString() (yes, the toString()) method to fail:\n\n```\n[2021-07-16 15:32:23,315] [AsyncReviewerManager-1] WARN  com.googlesource.gerrit.owners.common.AsyncReviewerManager : [FAILED toString()] *FAILED*: retry #2 after 3000 msec\ncom.googlesource.gerrit.owners.common.ReviewerManagerException: Explicit failure\n```\n\nNote the ```[FAILED toString()] ```\n\n\nThe reason the toString() fails is because the `changeNum` cannot be obtained outside a RequestScope (this is clear from the logs):\n\n```\ncom.google.inject.ProvisionException: Unable to provision, see the following errors:\n\n1) Automatic ReviewDb only available in request scope\n  at com.google.gerrit.server.util.ThreadLocalRequestContext$1.provideReviewDb(Unknown Source) (via modules: com.google.gerrit.server.config.GerritGlobalModule -\u003e com.google.gerrit.server.util.ThreadLocalRequestContext$1)\n  while locating com.google.gerrit.reviewdb.server.ReviewDb\n```\n\nGetting the change number immediately (in the constructor) fixes the problem (i.e. removing the supplier and run the REST-API call immediately), but I understand why you don\u0027t want that.\nPerhaps you can think of some other ways to work around this?\n\nFull stack trace here [1]\n\n[1] https://pastebin.com/JiFwvSEW",
      "range": {
        "startLine": 53,
        "startChar": 0,
        "endLine": 62,
        "endChar": 17
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d6891302_a593ce2b",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 62,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "Good catch. I will set his value in the constructor, so that we avoid unexpected invocations.",
      "parentUuid": "2fd7366b_c07bff4e",
      "range": {
        "startLine": 53,
        "startChar": 0,
        "endLine": 62,
        "endChar": 17
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "841354f8_298dafcd",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 81,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-07-16T08:27:51Z",
      "side": 1,
      "message": "nit: retryNum is a part of \u0027toString\u0027 hence it will be logged through \u0027this\u0027 and it doesn\u0027t have to be repeated",
      "range": {
        "startLine": 81,
        "startChar": 56,
        "endLine": 81,
        "endChar": 65
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9b0db4b1_cdcdbb47",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 81,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-16T14:03:27Z",
      "side": 1,
      "message": "+1\nI have actually tested retries and (when when fixing the toString() method, see my other comment), this get logged as:\n\n```\nauto-assign reviewers to change 121(retry #4) *FAILED*: retry #4 after 3000 msec\n```\n\nSo the redundancy should be removed.",
      "parentUuid": "841354f8_298dafcd",
      "range": {
        "startLine": 81,
        "startChar": 56,
        "endLine": 81,
        "endChar": 65
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5a445ede_345c2cd5",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 81,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9b0db4b1_cdcdbb47",
      "range": {
        "startLine": 81,
        "startChar": 56,
        "endLine": 81,
        "endChar": 65
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9b2acfca_92ae910d",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 84,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-07-16T08:27:51Z",
      "side": 1,
      "message": "nit: retryNum is a part of \u0027toString\u0027 hence it will be logged through \u0027this\u0027 and it doesn\u0027t have to be repeated",
      "range": {
        "startLine": 84,
        "startChar": 65,
        "endLine": 84,
        "endChar": 73
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "db4a5c4f_fee09ac6",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 84,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9b2acfca_92ae910d",
      "range": {
        "startLine": 84,
        "startChar": 65,
        "endLine": 84,
        "endChar": 73
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6f1116ee_4832350a",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 89,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-07-16T08:27:51Z",
      "side": 1,
      "message": "nit: have you consider using com.google.gerrit.server.update.RetryHelper from Gerrit core?",
      "range": {
        "startLine": 74,
        "startChar": 4,
        "endLine": 89,
        "endChar": 3
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9bf0da5c_ed5d5f57",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AsyncReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 89,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "I did in the past, but the RetryHelper is specific to ref-udpates, whilst here is a generic operation to be retried.\n\nAlso, I believe it already uses it because the ref-update that is failing here for lock error *has already* gone through the RetryHelper.",
      "parentUuid": "6f1116ee_4832350a",
      "range": {
        "startLine": 74,
        "startChar": 4,
        "endLine": 89,
        "endChar": 3
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bf548ea5_29442222",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AutoAssignConfig.java",
        "patchSetId": 2
      },
      "lineNbr": 28,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-16T14:03:27Z",
      "side": 1,
      "message": "I think mentioning this in the config.md would be really useful (even in a follow up change):\n\netc/owners-autoassign.config\n\n```\n[reviewers]\n  async \u003d false\n  delay \u003d 1500 ms\n  retryCount \u003d 2\n  retryInterval \u003d 1500 ms\n  threads \u003d 1\n```",
      "range": {
        "startLine": 28,
        "startChar": 13,
        "endLine": 28,
        "endChar": 29
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fdac4d9b_327a7aaa",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/AutoAssignConfig.java",
        "patchSetId": 2
      },
      "lineNbr": 28,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:29:36Z",
      "side": 1,
      "message": "Yes, let me follow this up in the next commit.",
      "parentUuid": "bf548ea5_29442222",
      "range": {
        "startLine": 28,
        "startChar": 13,
        "endLine": 28,
        "endChar": 29
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "248d4ebc_aae2c470",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/ReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 24,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2021-07-16T14:03:27Z",
      "side": 1,
      "message": "nit: \u0027public\u0027 is redundant for interface methods",
      "range": {
        "startLine": 24,
        "startChar": 2,
        "endLine": 24,
        "endChar": 8
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a9711203_ebf61da2",
        "filename": "owners-autoassign/src/main/java/com/googlesource/gerrit/owners/common/ReviewerManager.java",
        "patchSetId": 2
      },
      "lineNbr": 24,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "248d4ebc_aae2c470",
      "range": {
        "startLine": 24,
        "startChar": 2,
        "endLine": 24,
        "endChar": 8
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf3649ad_125f263c",
        "filename": "owners-autoassign/src/test/java/com/vmware/gerrit/owners/common/GitRefListenerTest.java",
        "patchSetId": 2
      },
      "lineNbr": 31,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2021-07-16T08:27:51Z",
      "side": 1,
      "message": "Would it make sense to enable this test to see if nothing got broken?",
      "range": {
        "startLine": 31,
        "startChar": 0,
        "endLine": 31,
        "endChar": 7
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cffcc8a5_36636845",
        "filename": "owners-autoassign/src/test/java/com/vmware/gerrit/owners/common/GitRefListenerTest.java",
        "patchSetId": 2
      },
      "lineNbr": 31,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-07-16T17:28:42Z",
      "side": 1,
      "message": "Despite its name, this isn\u0027t a test but a dummy listener.\nIt is annotate with @Ignore just for avoiding Bazel to think that this is a test to be run.",
      "parentUuid": "cf3649ad_125f263c",
      "range": {
        "startLine": 31,
        "startChar": 0,
        "endLine": 31,
        "endChar": 7
      },
      "revId": "c53c497e5bf1350349f31f02494c295c43fe0cf9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}